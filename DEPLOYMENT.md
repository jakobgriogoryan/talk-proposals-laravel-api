# Deployment Guide

This guide covers deploying the Talk Proposals system to a production environment.

## üìã Table of Contents

- [Prerequisites](#prerequisites)
- [Server Requirements](#server-requirements)
- [Backend Deployment](#backend-deployment)
- [Frontend Deployment](#frontend-deployment)
- [Database Setup](#database-setup)
- [Environment Configuration](#environment-configuration)
- [WebSocket Configuration](#websocket-configuration)
- [Security Checklist](#security-checklist)
- [Performance Optimization](#performance-optimization)
- [Monitoring & Maintenance](#monitoring--maintenance)

## üîß Prerequisites

- Production server (VPS, Cloud instance, etc.)
- Domain name configured with DNS
- SSL certificate (Let's Encrypt recommended)
- SSH access to server
- Database server (MySQL/PostgreSQL)

## üñ• Server Requirements

### Minimum Requirements

- **PHP**: 8.2 or higher
- **Composer**: Latest version
- **Node.js**: 20.19.0+ or 22.12.0+
- **Web Server**: Nginx 1.18+ or Apache 2.4+
- **Database**: MySQL 8.0+ or PostgreSQL 13+
- **Memory**: 512MB RAM minimum (1GB+ recommended)
- **Storage**: 2GB+ free space

### PHP Extensions Required

```bash
php -m | grep -E "pdo|mbstring|xml|curl|openssl|json|bcmath|fileinfo"
```

Required extensions:
- `pdo_mysql` or `pdo_pgsql`
- `mbstring`
- `xml`
- `curl`
- `openssl`
- `json`
- `bcmath`
- `fileinfo`
- `zip`

## üöÄ Backend Deployment

### 1. Server Setup

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install PHP and extensions
sudo apt install php8.2-fpm php8.2-cli php8.2-mysql php8.2-xml php8.2-mbstring php8.2-curl php8.2-zip php8.2-bcmath

# Install Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# Install Node.js (if not already installed)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

### 2. Clone and Setup Application

```bash
# Navigate to web root
cd /var/www

# Clone repository (or upload files)
sudo git clone <repository-url> talk-proposals
cd talk-proposals/talk-proposals-api

# Install dependencies
composer install --optimize-autoloader --no-dev

# Set permissions
sudo chown -R www-data:www-data /var/www/talk-proposals
sudo chmod -R 755 /var/www/talk-proposals
sudo chmod -R 775 storage bootstrap/cache
```

### 3. Environment Configuration

```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Edit .env file
nano .env
```

**Production .env Configuration:**

```env
APP_NAME="Talk Proposals API"
APP_ENV=production
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=false
APP_URL=https://api.yourdomain.com

LOG_CHANNEL=stack
LOG_LEVEL=error

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=talk_proposals
DB_USERNAME=your_db_user
DB_PASSWORD=your_secure_password

# Session & Sanctum
SESSION_DRIVER=cookie
SESSION_LIFETIME=120
SESSION_SECURE_COOKIE=true
SESSION_SAME_SITE=lax
SESSION_DOMAIN=.yourdomain.com

SANCTUM_STATEFUL_DOMAINS=yourdomain.com,www.yourdomain.com

# Frontend URL
FRONTEND_URL=https://yourdomain.com

# Broadcasting (if using WebSockets)
BROADCAST_CONNECTION=pusher
PUSHER_APP_ID=your_pusher_app_id
PUSHER_APP_KEY=your_pusher_key
PUSHER_APP_SECRET=your_pusher_secret
PUSHER_APP_CLUSTER=mt1
PUSHER_HOST=
PUSHER_PORT=443
PUSHER_SCHEME=https

# Queue (recommended for production)
QUEUE_CONNECTION=database
# Or use Redis: QUEUE_CONNECTION=redis

# Cache
CACHE_DRIVER=file
# Or use Redis: CACHE_DRIVER=redis

# Mail
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_mail_username
MAIL_PASSWORD=your_mail_password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"
```

### 4. Run Migrations

```bash
# Run migrations
php artisan migrate --force

# (Optional) Seed database
php artisan db:seed --force
```

### 5. Optimize Application

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

### 6. Configure Web Server

#### Nginx Configuration

Create `/etc/nginx/sites-available/talk-proposals-api`:

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;
    root /var/www/talk-proposals/talk-proposals-api/public;

    index index.php;

    charset utf-8;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Increase upload size for file uploads
    client_max_body_size 5M;
}
```

Enable site:

```bash
sudo ln -s /etc/nginx/sites-available/talk-proposals-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### Apache Configuration

Create virtual host configuration and ensure mod_rewrite is enabled.

### 7. Setup Queue Worker (Recommended)

```bash
# Create systemd service
sudo nano /etc/systemd/system/talk-proposals-queue.service
```

Service file:

```ini
[Unit]
Description=Talk Proposals Queue Worker
After=network.target

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/talk-proposals/talk-proposals-api/artisan queue:work --sleep=3 --tries=3 --max-time=3600

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl enable talk-proposals-queue
sudo systemctl start talk-proposals-queue
```

## üé® Frontend Deployment

### 1. Build for Production

```bash
cd /var/www/talk-proposals/talk-proposals-frontend

# Install dependencies
npm ci

# Build for production
npm run build
```

### 2. Configure Web Server

#### Nginx Configuration for Frontend

Create `/etc/nginx/sites-available/talk-proposals-frontend`:

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/talk-proposals/talk-proposals-frontend/dist;

    index index.html;

    charset utf-8;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # API Proxy
    location /api {
        proxy_pass https://api.yourdomain.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SPA Routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. Update Frontend Configuration

Ensure `vite.config.js` has correct API base URL for production:

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'https://api.yourdomain.com',
        changeOrigin: true,
      },
    },
  },
})
```

## üóÑ Database Setup

### 1. Create Database

```sql
CREATE DATABASE talk_proposals CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'talk_proposals_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON talk_proposals.* TO 'talk_proposals_user'@'localhost';
FLUSH PRIVILEGES;
```

### 2. Run Migrations

```bash
cd /var/www/talk-proposals/talk-proposals-api
php artisan migrate --force
```

### 3. Seed Database (Optional)

```bash
php artisan db:seed --force
```

## üîê Environment Configuration

### Critical Production Settings

1. **APP_ENV=production**
2. **APP_DEBUG=false**
3. **SESSION_SECURE_COOKIE=true** (HTTPS required)
4. **Strong database passwords**
5. **Secure APP_KEY** (never commit to version control)

### Domain Configuration

Ensure these match your actual domains:

- `APP_URL=https://api.yourdomain.com`
- `FRONTEND_URL=https://yourdomain.com`
- `SESSION_DOMAIN=.yourdomain.com`
- `SANCTUM_STATEFUL_DOMAINS=yourdomain.com,www.yourdomain.com`

## üì° WebSocket Configuration

If using real-time features, configure Pusher:

1. Create Pusher account at https://pusher.com
2. Create a new app
3. Get credentials and add to `.env`
4. Ensure frontend has correct Pusher configuration

See [WEBSOCKET_SETUP.md](./WEBSOCKET_SETUP.md) for details. (File is in the same directory)

## üîí Security Checklist

- [ ] `APP_DEBUG=false` in production
- [ ] Strong `APP_KEY` generated
- [ ] Secure database credentials
- [ ] SSL/TLS certificates installed
- [ ] `SESSION_SECURE_COOKIE=true`
- [ ] CORS properly configured
- [ ] File upload limits set
- [ ] Rate limiting enabled (if needed)
- [ ] Firewall configured
- [ ] Regular security updates
- [ ] Backup strategy in place

### Additional Security Measures

```bash
# Set proper file permissions
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 755 storage bootstrap/cache

# Hide sensitive files
echo ".env" >> .gitignore
echo "storage/*" >> .gitignore
```

## ‚ö° Performance Optimization

### 1. Enable OPcache

Edit `/etc/php/8.2/fpm/php.ini`:

```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
```

### 2. Use Redis for Cache/Queue (Recommended)

```bash
# Install Redis
sudo apt install redis-server

# Update .env
CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### 3. Enable Gzip Compression

Add to Nginx config:

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

## üìä Monitoring & Maintenance

### 1. Log Monitoring

```bash
# View Laravel logs
tail -f storage/logs/laravel.log

# View Nginx logs
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log
```

### 2. Database Backups

```bash
# Create backup script
#!/bin/bash
mysqldump -u talk_proposals_user -p talk_proposals > /backups/talk_proposals_$(date +%Y%m%d_%H%M%S).sql

# Add to crontab (daily at 2 AM)
0 2 * * * /path/to/backup-script.sh
```

### 3. Update Application

```bash
# Pull latest changes
git pull origin main

# Update dependencies
composer install --optimize-autoloader --no-dev
npm ci && npm run build

# Run migrations
php artisan migrate --force

# Clear and cache
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart queue worker
sudo systemctl restart talk-proposals-queue
```

### 4. Health Checks

Create a health check endpoint or use Laravel's built-in:

```
https://api.yourdomain.com/up
```

## üêõ Troubleshooting

### Common Issues

1. **500 Internal Server Error**
   - Check file permissions
   - Review Laravel logs
   - Verify `.env` configuration

2. **Database Connection Failed**
   - Verify database credentials
   - Check database server is running
   - Ensure firewall allows connections

3. **Session/Cookie Issues**
   - Verify `SESSION_DOMAIN` matches actual domain
   - Ensure HTTPS is configured
   - Check `SANCTUM_STATEFUL_DOMAINS`

4. **File Upload Fails**
   - Check `storage` directory permissions
   - Verify `upload_max_filesize` in PHP
   - Check Nginx `client_max_body_size`

## üìù Post-Deployment Checklist

- [ ] Application accessible via HTTPS
- [ ] API endpoints responding correctly
- [ ] Frontend loading and routing works
- [ ] Authentication working
- [ ] File uploads working
- [ ] Database migrations applied
- [ ] Queue worker running
- [ ] Logs being written
- [ ] Backups configured
- [ ] Monitoring set up

---

**Need Help?** Check the main [../README.md](../README.md) or review Laravel/Vue.js documentation.

